#
# docker build -t mgrast/m5nr-upload -f upload/Dockerfile-upload .
# docker run -i -d \
#        --name m5nr-upload \
#        -v $DIR/m5nr/:/m5nr_data/ \
#        -v $DIR/docker:/docker/ \
#        -v /var/run/docker.sock:/var/run/docker.sock
#        mgrast/m5nr-upload bash
#
# M5NR_VERSION=12
# DOCKERVERSION=`/usr/bin/docker --version | grep -o '[0-9]*\.[0-9]*\.[0-9][a-z-]*'`
# SOLR_URL="http://140.221.76.69:8983/solr"
# ALL_IPS=`fleetctl list-units | grep cassandra | cut -f2 -d"/" | cut -f1 | sort -u | tr "\n" ","`
#
# docker exec m5nr-upload m5nr_master.sh -a upload -v $M5NR_VERSION -t $TOKEN
# docker exec m5nr-upload docker_setup.sh $DOCKERVERSION
# docker exec m5nr-upload solr_load.sh -n -i $INPUT_URI -v $M5NR_VERSION -s $SOLR_URL
# docker exec m5nr-upload load-cassandra-m5nr.sh -v $M5NR_VERSION -u $INPUT_URI -i $COREOS_PRIVATE_IPV4 -a $ALL_IPS
#

FROM cassandra:3.10

RUN apt-get update && apt-get install -y \
  software-properties-common \
  git-core \
  wget \
  dh-autoreconf \
  vim \
  curl \
  python-yaml \
  python-pip

RUN add-apt-repository ppa:openjdk-r/ppa
RUN apt-get update && apt-get install -y \
  openjdk-8-jdk \
  maven

# python dependencies
RUN pip2 install --upgrade pip
RUN python -m pip install requests_toolbelt cassandra-driver

### install solr-import-export-json
RUN cd / \
    && git clone https://github.com/freedev/solr-import-export-json.git \
    && cd solr-import-export-json \
    && mvn clean package

### install yq
RUN curl -L "https://github.com/mikefarah/yq/releases/download/1.14.0/yq_linux_amd64" > /usr/bin/yq \
    && chmod +x /usr/bin/yq

# copy myM5NR and set up env
RUN mkdir -p /myM5NR /myM5NR/bin /myM5NR/BulkLoader
COPY bin/* /myM5NR/bin/
COPY upload/bin/* /myM5NR/bin/
COPY config/upload.yaml /myM5NR/
COPY upload/schema/* /myM5NR/schema/
COPY upload/BulkLoader/* /myM5NR/BulkLoader/
ENV PATH $PATH:/myM5NR/bin

RUN mkdir -p /m5nr_data
WORKDIR /m5nr_data
